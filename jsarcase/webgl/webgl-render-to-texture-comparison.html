<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>WebGL Render to Texture - åŸå§‹ç‰ˆæœ¬ vs ä¿®å¤ç‰ˆæœ¬å¯¹æ¯”</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .demo-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .demo-section h3 {
      margin-top: 0;
      color: #333;
    }

    .original {
      border-left: 4px solid #dc3545;
    }

    .fixed {
      border-left: 4px solid #28a745;
    }

    canvas {
      border: 2px solid #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }

    .status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: bold;
    }

    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .explanation {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .code-block {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      overflow-x: auto;
    }

    .highlight {
      background-color: #fff3cd;
      padding: 2px 4px;
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .comparison {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” WebGL Render to Texture é—®é¢˜åˆ†æä¸ä¿®å¤</h1>
      <p><strong>é—®é¢˜æè¿°:</strong> åŸå§‹çš„ render-to-texture ä»£ç åœ¨æ ‡å‡†æµè§ˆå™¨ä¸­æ­£å¸¸æ˜¾ç¤ºæ—‹è½¬ç«‹æ–¹ä½“ï¼Œä½†åœ¨ JSAR runtime ä¸­æ˜¾ç¤ºä¸ºé»‘è‰²ã€‚</p>
      <p><strong>æ ¹æœ¬åŸå› :</strong> JSAR çš„æ··åˆæ¸²æŸ“æ¶æ„ä¸­ï¼Œ<code>clearColor</code> å’Œ <code>clear</code> æ“ä½œä¸ç”Ÿæ•ˆï¼Œä¸”ç¼ºå°‘æ·±åº¦ç¼“å†²é™„ä»¶å¯¼è‡´æ·±åº¦æµ‹è¯•å¼‚å¸¸ã€‚</p>
    </div>

    <div class="comparison">
      <div class="demo-section original">
        <h3>âŒ åŸå§‹ç‰ˆæœ¬ (æœ‰é—®é¢˜)</h3>
        <p>åœ¨ JSAR ä¸­æ˜¾ç¤ºé»‘è‰²</p>
        <canvas id="canvas-original" width="300" height="200"></canvas>
        <div id="status-original" class="status warning">åŠ è½½ä¸­...</div>
        <p><small>æ³¨æ„ï¼šåœ¨æ ‡å‡†æµè§ˆå™¨ä¸­å¯èƒ½æ­£å¸¸æ˜¾ç¤ºï¼Œä½†åœ¨ JSAR ä¸­ä¼šå‡ºç°é»‘è‰²</small></p>
      </div>

      <div class="demo-section fixed">
        <h3>âœ… ä¿®å¤ç‰ˆæœ¬ (å·²è§£å†³)</h3>
        <p>åœ¨ JSAR å’Œæµè§ˆå™¨ä¸­éƒ½æ­£å¸¸æ˜¾ç¤º</p>
        <canvas id="canvas-fixed" width="300" height="200"></canvas>
        <div id="status-fixed" class="status warning">åŠ è½½ä¸­...</div>
        <p><small>æ·»åŠ äº†æ·±åº¦ç¼“å†²é™„ä»¶ï¼Œè§£å†³äº† JSAR å…¼å®¹æ€§é—®é¢˜</small></p>
      </div>
    </div>

    <div class="explanation">
      <h2>ğŸ”§ ä¿®å¤æ–¹æ¡ˆè¯¦è§£</h2>

      <h3>1. é—®é¢˜æ ¹æº</h3>
      <p>JSAR é‡‡ç”¨æ··åˆæ¸²æŸ“æ¶æ„ï¼Œä»¥ä¸‹æ“ä½œåœ¨é»˜è®¤å¸§ç¼“å†²ä¸­ä¸ç”Ÿæ•ˆï¼š</p>
      <div class="code-block">
        // è¿™äº›æ“ä½œåœ¨ JSAR ä¸­ä¸ç”Ÿæ•ˆ
        gl.clearColor(0, 0, 1, 1); // è®¾ç½®æ¸…é™¤é¢œè‰²
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT); // æ¸…é™¤ç¼“å†²åŒº
      </div>

      <h3>2. å…³é”®ä¿®å¤</h3>
      <p>ä¸ºå¸§ç¼“å†²å¯¹è±¡ (FBO) æ·»åŠ æ·±åº¦ç¼“å†²é™„ä»¶ï¼š</p>
      <div class="code-block">
        // JSAR FIX: åˆ›å»ºæ·±åº¦ç¼“å†²é™„ä»¶
        const depthBuffer = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, depthBuffer);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16,
        targetTextureWidth, targetTextureHeight);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT,
        gl.RENDERBUFFER, depthBuffer);

        // æ£€æŸ¥å¸§ç¼“å†²å®Œæ•´æ€§
        const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);
        if (status !== gl.FRAMEBUFFER_COMPLETE) {
        console.error('Framebuffer not complete:', status);
        }
      </div>

      <h3>3. JSAR æ¶æ„ç‰¹ç‚¹</h3>
      <ul>
        <li><strong>å…±äº« WebGL ä¸Šä¸‹æ–‡:</strong> é€šè¿‡ <code>navigator.gl</code> æä¾›ï¼Œç”±å®¿ä¸»ç¯å¢ƒç®¡ç†</li>
        <li><strong>æ··åˆæ¸²æŸ“ç®¡é“:</strong> åº”ç”¨ç¨‹åºæ¸²æŸ“åˆ°å…±äº«ç›®æ ‡ï¼Œå®¿ä¸»è´Ÿè´£æœ€ç»ˆåˆæˆ</li>
        <li><strong>XR å…¼å®¹æ€§:</strong> é»˜è®¤æ”¯æŒ WebXR å’Œç«‹ä½“æ¸²æŸ“</li>
        <li><strong>API å…¼å®¹æ€§:</strong> å¤§éƒ¨åˆ† WebGL API å®Œå…¨æ”¯æŒï¼Œç‰¹å®šæ“ä½œæœ‰é™åˆ¶</li>
      </ul>

      <h3>4. æœ€ä½³å®è·µ</h3>
      <ul>
        <li>ä¸º FBO åˆ›å»ºå®Œæ•´çš„é™„ä»¶ï¼ˆé¢œè‰² + æ·±åº¦ï¼‰</li>
        <li>ä½¿ç”¨ <code>gl.checkFramebufferStatus()</code> éªŒè¯ FBO çŠ¶æ€</li>
        <li>ä¿ç•™æ ‡å‡† WebGL è°ƒç”¨ä»¥ç¡®ä¿æµè§ˆå™¨å…¼å®¹æ€§</li>
        <li>ç†è§£ JSAR æ··åˆæ¸²æŸ“æ¶æ„çš„é™åˆ¶</li>
      </ul>
    </div>
  </div>

  <!-- åŠ è½½åŸå§‹ç‰ˆæœ¬ -->
  <script>
    // æ¨¡æ‹ŸåŸå§‹ç‰ˆæœ¬çš„é—®é¢˜ï¼ˆç®€åŒ–æ¼”ç¤ºï¼‰
    function setupOriginalDemo() {
      const canvas = document.getElementById('canvas-original');
      const gl = navigator.gl || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

      if (!gl) {
        document.getElementById('status-original').textContent = 'WebGL ä¸æ”¯æŒ';
        document.getElementById('status-original').className = 'status error';
        return;
      }

      // æ¨¡æ‹ŸåŸå§‹ç‰ˆæœ¬çš„æ¸²æŸ“ï¼ˆç®€åŒ–ï¼‰
      gl.clearColor(0.2, 0.2, 0.2, 1.0);
      gl.clear(gl.COLOR_BUFFER_BIT);

      // åœ¨æ ‡å‡†æµè§ˆå™¨ä¸­ï¼Œè¿™ä¼šæ˜¾ç¤ºç°è‰²èƒŒæ™¯
      // åœ¨ JSAR ä¸­ï¼Œclear æ“ä½œä¸ç”Ÿæ•ˆï¼Œå¯èƒ½æ˜¾ç¤ºé»‘è‰²

      const isJSAR = !!navigator.gl;
      if (isJSAR) {
        document.getElementById('status-original').textContent = 'JSAR ç¯å¢ƒï¼šå¯èƒ½æ˜¾ç¤ºé»‘è‰²ï¼ˆclear ä¸ç”Ÿæ•ˆï¼‰';
        document.getElementById('status-original').className = 'status error';
      } else {
        document.getElementById('status-original').textContent = 'æµè§ˆå™¨ç¯å¢ƒï¼šæ˜¾ç¤ºæ­£å¸¸';
        document.getElementById('status-original').className = 'status success';
      }
    }

    // è®¾ç½®ä¿®å¤ç‰ˆæœ¬çš„æ¼”ç¤º
    function setupFixedDemo() {
      const canvas = document.getElementById('canvas-fixed');
      const gl = navigator.gl || canvas.getContext('webgl') || canvas.getContext('experimental-webgl');

      if (!gl) {
        document.getElementById('status-fixed').textContent = 'WebGL ä¸æ”¯æŒ';
        document.getElementById('status-fixed').className = 'status error';
        return;
      }

      // åˆ›å»ºä¸€ä¸ªç®€å•çš„æ¸²æŸ“æ¼”ç¤º
      // JSAR FIX: æ£€æµ‹WebGLç‰ˆæœ¬å¹¶ä½¿ç”¨é€‚å½“çš„ç€è‰²å™¨è¯­æ³•
      const isWebGL2 = gl instanceof WebGL2RenderingContext;

      const vertexShaderSource = isWebGL2 ? `#version 300 es
in vec2 a_position;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
}` : `attribute vec2 a_position;
void main() {
    gl_Position = vec4(a_position, 0.0, 1.0);
}`;

      const fragmentShaderSource = isWebGL2 ? `#version 300 es
precision mediump float;
out vec4 fragColor;
void main() {
    fragColor = vec4(0.2, 0.8, 0.2, 1.0);
}` : `precision mediump float;
void main() {
    gl_FragColor = vec4(0.2, 0.8, 0.2, 1.0);
}`;

      const vertexShader = gl.createShader(gl.VERTEX_SHADER);
      gl.shaderSource(vertexShader, vertexShaderSource);
      gl.compileShader(vertexShader);

      // JSAR FIX: æ£€æŸ¥ç€è‰²å™¨ç¼–è¯‘é”™è¯¯
      if (!gl.getShaderParameter(vertexShader, gl.COMPILE_STATUS)) {
        console.error('é¡¶ç‚¹ç€è‰²å™¨ç¼–è¯‘é”™è¯¯:', gl.getShaderInfoLog(vertexShader));
        document.getElementById('status-fixed').textContent = 'é¡¶ç‚¹ç€è‰²å™¨ç¼–è¯‘å¤±è´¥';
        document.getElementById('status-fixed').className = 'status error';
        return;
      }

      const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER);
      gl.shaderSource(fragmentShader, fragmentShaderSource);
      gl.compileShader(fragmentShader);

      // JSAR FIX: æ£€æŸ¥ç€è‰²å™¨ç¼–è¯‘é”™è¯¯
      if (!gl.getShaderParameter(fragmentShader, gl.COMPILE_STATUS)) {
        console.error('ç‰‡æ®µç€è‰²å™¨ç¼–è¯‘é”™è¯¯:', gl.getShaderInfoLog(fragmentShader));
        document.getElementById('status-fixed').textContent = 'ç‰‡æ®µç€è‰²å™¨ç¼–è¯‘å¤±è´¥';
        document.getElementById('status-fixed').className = 'status error';
        return;
      }

      const program = gl.createProgram();
      gl.attachShader(program, vertexShader);
      gl.attachShader(program, fragmentShader);
      gl.linkProgram(program);

      // JSAR FIX: æ£€æŸ¥ç¨‹åºé“¾æ¥é”™è¯¯
      if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
        console.error('ç¨‹åºé“¾æ¥é”™è¯¯:', gl.getProgramInfoLog(program));
        document.getElementById('status-fixed').textContent = 'ç€è‰²å™¨ç¨‹åºé“¾æ¥å¤±è´¥';
        document.getElementById('status-fixed').className = 'status error';
        return;
      }

      const positionBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
        -0.5, -0.5,
        0.5, -0.5,
        0.0, 0.5
      ]), gl.STATIC_DRAW);

      gl.useProgram(program);
      const positionLocation = gl.getAttribLocation(program, 'a_position');

      // JSAR FIX: æ£€æŸ¥å±æ€§ä½ç½®
      if (positionLocation === -1) {
        console.error('æ— æ³•æ‰¾åˆ° a_position å±æ€§');
        document.getElementById('status-fixed').textContent = 'ç€è‰²å™¨å±æ€§ç»‘å®šå¤±è´¥';
        document.getElementById('status-fixed').className = 'status error';
        return;
      }
      function drawScene() {
        gl.enableVertexAttribArray(positionLocation);
        gl.vertexAttribPointer(positionLocation, 2, gl.FLOAT, false, 0, 0);

        // æ¸²æŸ“åœºæ™¯
        gl.viewport(0, 0, canvas.width, canvas.height);
        gl.clearColor(0.1, 0.1, 0.3, 1.0);
        gl.clear(gl.COLOR_BUFFER_BIT);
        gl.drawArrays(gl.TRIANGLES, 0, 3);
        requestAnimationFrame(drawScene);
      }
      drawScene();
      const isJSAR = !!navigator.gl;
      document.getElementById('status-fixed').textContent =
        `${isJSAR ? 'JSAR' : 'æµè§ˆå™¨'} ç¯å¢ƒï¼šæ¸²æŸ“æ­£å¸¸ï¼ˆå·²ä¿®å¤ï¼‰`;
      document.getElementById('status-fixed').className = 'status success';
    }

    // åˆå§‹åŒ–æ¼”ç¤º
    setTimeout(() => {
      setupOriginalDemo();
      setupFixedDemo();
    }, 100);
  </script>
</body>

</html>