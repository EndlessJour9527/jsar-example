<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebGL Async Loader Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    #log {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebGL Async Loader Test for JSAR Runtime</h1>
    <p>这个测试验证WebGL异步加载器是否能正确处理JSAR runtime中的依赖加载问题。</p>
    
    <div id="status" class="status info">🔄 正在初始化测试...</div>
    
    <h3>测试步骤:</h3>
    <ol>
      <li>加载WebGL异步加载器</li>
      <li>检测运行环境 (JSAR Runtime vs Browser)</li>
      <li>等待WebGL测试依赖加载完成</li>
      <li>执行WebGL测试验证</li>
    </ol>
    
    <div id="log"></div>
  </div>

  <!-- Load WebGL async loader -->
  <!-- <script src="./webgl-async-loader.js"></script> -->
  
  <script type="module">
    // Use global waitForWebGLTestGlobals function
    import * as loader from './webgl-async-loader.js';
    const { waitForWebGLTestGlobals } = loader;

    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    
    function updateStatus(message, type = 'info') {
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }
    
    function log(message) {
      console.log(message);
      logDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function runTest() {
      log('开始WebGL异步加载器测试...');
      
      // 检查异步加载器是否可用
      if (typeof waitForWebGLTestGlobals === 'undefined') {
        updateStatus('❌ 异步加载器未找到', 'error');
        log('错误: waitForWebGLTestGlobals 函数未定义');
        return;
      }
      
      log('✅ 异步加载器已加载');
      
      // 模拟WebGL测试依赖
      const testGlobals = ['WebGLTestUtils', 'description', 'debug'];
      
      // 检查当前环境
      const isJSAR = typeof window !== 'undefined' && 
                     (window.navigator && window.navigator.userAgent && 
                      window.navigator.userAgent.includes('JSAR'));
      
      if (isJSAR) {
        log('🔄 检测到JSAR Runtime环境');
        updateStatus('🔄 等待WebGL依赖加载...', 'warning');
        
        // 使用异步加载器等待依赖
        waitForWebGLTestGlobals(function() {
          log('✅ 所有WebGL测试依赖已加载完成');
          updateStatus('✅ 测试成功完成', 'success');
          log('测试结果: 异步加载器工作正常');
        }, {
          maxRetries: 100,
          retryInterval: 50,
          timeout: 5000,
          onTimeout: function() {
            log('❌ 超时: WebGL依赖加载超时');
            updateStatus('❌ 测试超时', 'error');
          },
          onError: function() {
            log('❌ 错误: 达到最大重试次数');
            updateStatus('❌ 测试失败', 'error');
          }
        });
      } else {
        log('🌐 检测到浏览器环境');
        updateStatus('🌐 浏览器环境测试', 'info');
        
        // 在浏览器中直接验证
        setTimeout(function() {
          log('✅ 浏览器环境测试完成');
          updateStatus('✅ 浏览器测试成功', 'success');
          log('注意: 在真实的JSAR Runtime中才能完全验证异步加载功能');
        }, 500);
      }
    }
    
    // 页面加载完成后开始测试
    setTimeout(runTest, 500);
    // document.addEventListener('DOMContentLoaded', function() {
    // });
  </script>
</body>
</html>