<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebGL Async Loader Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
    #log {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      padding: 15px;
      margin-top: 20px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebGL Async Loader Test for JSAR Runtime</h1>
    <p>è¿™ä¸ªæµ‹è¯•éªŒè¯WebGLå¼‚æ­¥åŠ è½½å™¨æ˜¯å¦èƒ½æ­£ç¡®å¤„ç†JSAR runtimeä¸­çš„ä¾èµ–åŠ è½½é—®é¢˜ã€‚</p>
    
    <div id="status" class="status info">ğŸ”„ æ­£åœ¨åˆå§‹åŒ–æµ‹è¯•...</div>
    
    <h3>æµ‹è¯•æ­¥éª¤:</h3>
    <ol>
      <li>åŠ è½½WebGLå¼‚æ­¥åŠ è½½å™¨</li>
      <li>æ£€æµ‹è¿è¡Œç¯å¢ƒ (JSAR Runtime vs Browser)</li>
      <li>ç­‰å¾…WebGLæµ‹è¯•ä¾èµ–åŠ è½½å®Œæˆ</li>
      <li>æ‰§è¡ŒWebGLæµ‹è¯•éªŒè¯</li>
    </ol>
    
    <div id="log"></div>
  </div>

  <!-- Load WebGL async loader -->
  <!-- <script src="./webgl-async-loader.js"></script> -->
  
  <script type="module">
    // Use global waitForWebGLTestGlobals function
    import * as loader from './webgl-async-loader.js';
    const { waitForWebGLTestGlobals } = loader;

    const statusDiv = document.getElementById('status');
    const logDiv = document.getElementById('log');
    
    function updateStatus(message, type = 'info') {
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
    }
    
    function log(message) {
      console.log(message);
      logDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function runTest() {
      log('å¼€å§‹WebGLå¼‚æ­¥åŠ è½½å™¨æµ‹è¯•...');
      
      // æ£€æŸ¥å¼‚æ­¥åŠ è½½å™¨æ˜¯å¦å¯ç”¨
      if (typeof waitForWebGLTestGlobals === 'undefined') {
        updateStatus('âŒ å¼‚æ­¥åŠ è½½å™¨æœªæ‰¾åˆ°', 'error');
        log('é”™è¯¯: waitForWebGLTestGlobals å‡½æ•°æœªå®šä¹‰');
        return;
      }
      
      log('âœ… å¼‚æ­¥åŠ è½½å™¨å·²åŠ è½½');
      
      // æ¨¡æ‹ŸWebGLæµ‹è¯•ä¾èµ–
      const testGlobals = ['WebGLTestUtils', 'description', 'debug'];
      
      // æ£€æŸ¥å½“å‰ç¯å¢ƒ
      const isJSAR = typeof window !== 'undefined' && 
                     (window.navigator && window.navigator.userAgent && 
                      window.navigator.userAgent.includes('JSAR'));
      
      if (isJSAR) {
        log('ğŸ”„ æ£€æµ‹åˆ°JSAR Runtimeç¯å¢ƒ');
        updateStatus('ğŸ”„ ç­‰å¾…WebGLä¾èµ–åŠ è½½...', 'warning');
        
        // ä½¿ç”¨å¼‚æ­¥åŠ è½½å™¨ç­‰å¾…ä¾èµ–
        waitForWebGLTestGlobals(function() {
          log('âœ… æ‰€æœ‰WebGLæµ‹è¯•ä¾èµ–å·²åŠ è½½å®Œæˆ');
          updateStatus('âœ… æµ‹è¯•æˆåŠŸå®Œæˆ', 'success');
          log('æµ‹è¯•ç»“æœ: å¼‚æ­¥åŠ è½½å™¨å·¥ä½œæ­£å¸¸');
        }, {
          maxRetries: 100,
          retryInterval: 50,
          timeout: 5000,
          onTimeout: function() {
            log('âŒ è¶…æ—¶: WebGLä¾èµ–åŠ è½½è¶…æ—¶');
            updateStatus('âŒ æµ‹è¯•è¶…æ—¶', 'error');
          },
          onError: function() {
            log('âŒ é”™è¯¯: è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
            updateStatus('âŒ æµ‹è¯•å¤±è´¥', 'error');
          }
        });
      } else {
        log('ğŸŒ æ£€æµ‹åˆ°æµè§ˆå™¨ç¯å¢ƒ');
        updateStatus('ğŸŒ æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•', 'info');
        
        // åœ¨æµè§ˆå™¨ä¸­ç›´æ¥éªŒè¯
        setTimeout(function() {
          log('âœ… æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•å®Œæˆ');
          updateStatus('âœ… æµè§ˆå™¨æµ‹è¯•æˆåŠŸ', 'success');
          log('æ³¨æ„: åœ¨çœŸå®çš„JSAR Runtimeä¸­æ‰èƒ½å®Œå…¨éªŒè¯å¼‚æ­¥åŠ è½½åŠŸèƒ½');
        }, 500);
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹æµ‹è¯•
    setTimeout(runTest, 500);
    // document.addEventListener('DOMContentLoaded', function() {
    // });
  </script>
</body>
</html>