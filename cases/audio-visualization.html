<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音频可视化 - ThreeJS XR 测试案例</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
            pointer-events: none;
            text-shadow: 0 0 5px black;
        }
        #back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            z-index: 100;
        }
        #back-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #vr-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-weight: bold;
            z-index: 100;
        }
        #vr-button:hover {
            background-color: #0b7dda;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            z-index: 100;
        }
        button {
            margin: 5px;
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        #file-input {
            display: none;
        }
        #audio-info {
            position: absolute;
            bottom: 80px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            z-index: 100;
        }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="info">音频可视化 - 使用 ThreeJS 和 Web Audio API 创建音频可视化效果</div>
    <button id="back-button" onclick="window.location.href='../index.html'">返回</button>
    <button id="vr-button">进入 VR</button>
    <div id="controls">
        <button id="play-demo">播放示例音频</button>
        <button id="upload-audio">上传音频文件</button>
        <input type="file" id="file-input" accept="audio/*">
        <button id="toggle-play" disabled>播放/暂停</button>
        <button id="toggle-visualization">切换可视化模式</button>
    </div>
    <div id="audio-info">当前未播放任何音频</div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

        // 场景初始化
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);

        // 相机设置
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);

        // 渲染器设置
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // VR按钮
        document.getElementById('vr-button').addEventListener('click', function() {
            document.body.appendChild(VRButton.createButton(renderer));
            document.getElementById('vr-button').style.display = 'none';
        });

        // 控制器
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.update();

        // 光照设置
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(1, 1, 1).normalize();
        scene.add(directionalLight);

        // 创建地面
        const floorGeometry = new THREE.PlaneGeometry(20, 20);
        const floorMaterial = new THREE.MeshStandardMaterial({
            color: 0x222222,
            roughness: 0.8,
            metalness: 0.2
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // 网格辅助
        const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x444444);
        scene.add(gridHelper);

        // 音频可视化变量
        let audioContext, audioSource, analyser;
        let audioBuffer = null;
        let isPlaying = false;
        let audioElement = null;
        let visualizationMode = 0; // 0: 条形图, 1: 圆形, 2: 3D地形
        const visualizationModes = ['条形图', '圆形', '3D地形'];

        // 创建音频分析器
        function setupAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
            }
        }

        // 加载音频文件
        async function loadAudio(url) {
            setupAudioContext();
            
            try {
                const response = await fetch(url);
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                document.getElementById('toggle-play').disabled = false;
                document.getElementById('audio-info').textContent = `已加载示例音频`;
            } catch (error) {
                console.error('加载音频失败:', error);
                document.getElementById('audio-info').textContent = `加载音频失败: ${error.message}`;
            }
        }

        // 播放音频
        function playAudio() {
            if (!audioBuffer && !audioElement) return;
            
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            // 停止当前播放
            if (audioSource) {
                audioSource.disconnect();
            }
            
            if (audioBuffer) {
                // 播放音频缓冲区
                audioSource = audioContext.createBufferSource();
                audioSource.buffer = audioBuffer;
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
                audioSource.start(0);
                audioSource.onended = () => {
                    isPlaying = false;
                    document.getElementById('audio-info').textContent = '音频播放结束';
                };
            } else if (audioElement) {
                // 播放音频元素
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
                audioElement.play();
                audioElement.onended = () => {
                    isPlaying = false;
                    document.getElementById('audio-info').textContent = '音频播放结束';
                };
            }
            
            isPlaying = true;
            document.getElementById('audio-info').textContent = '正在播放音频';
        }

        // 暂停音频
        function pauseAudio() {
            if (audioElement && !audioElement.paused) {
                audioElement.pause();
                isPlaying = false;
                document.getElementById('audio-info').textContent = '音频已暂停';
            } else if (audioSource) {
                audioSource.stop();
                audioSource = null;
                isPlaying = false;
                document.getElementById('audio-info').textContent = '音频已停止';
            }
        }

        // 创建可视化对象
        const visualizationObjects = {
            bars: createBars(),
            circle: createCircle(),
            terrain: createTerrain()
        };

        // 创建条形可视化
        function createBars() {
            const group = new THREE.Group();
            group.position.set(0, 1, 0);
            
            const barCount = 128;
            const barWidth = 0.05;
            const barSpacing = 0.01;
            const totalWidth = barCount * (barWidth + barSpacing);
            
            const bars = [];
            const barMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1db954,
                metalness: 0.5,
                roughness: 0.1,
                emissive: 0x1db954,
                emissiveIntensity: 0.2
            });
            
            for (let i = 0; i < barCount; i++) {
                const barGeometry = new THREE.BoxGeometry(barWidth, 0.1, barWidth);
                const bar = new THREE.Mesh(barGeometry, barMaterial);
                
                const x = (i * (barWidth + barSpacing)) - (totalWidth / 2);
                bar.position.set(x, 0, 0);
                
                group.add(bar);
                bars.push(bar);
            }
            
            group.userData = { bars };
            group.visible = false;
            scene.add(group);
            return group;
        }

        // 创建圆形可视化
        function createCircle() {
            const group = new THREE.Group();
            group.position.set(0, 1, 0);
            
            const segmentCount = 128;
            const radius = 2;
            const segmentWidth = 0.05;
            const segmentDepth = 0.2;
            
            const segments = [];
            
            for (let i = 0; i < segmentCount; i++) {
                const angle = (i / segmentCount) * Math.PI * 2;
                const segmentGeometry = new THREE.BoxGeometry(segmentWidth, 0.1, segmentDepth);
                
                // 创建渐变材质
                const hue = (i / segmentCount) * 360;
                const color = new THREE.Color(`hsl(${hue}, 100%, 50%)`);
                
                const segmentMaterial = new THREE.MeshStandardMaterial({ 
                    color: color,
                    metalness: 0.5,
                    roughness: 0.1,
                    emissive: color,
                    emissiveIntensity: 0.3
                });
                
                const segment = new THREE.Mesh(segmentGeometry, segmentMaterial);
                
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;
                
                segment.position.set(x, 0, z);
                segment.rotation.y = angle + Math.PI / 2;
                
                group.add(segment);
                segments.push(segment);
            }
            
            // 添加中心球体
            const sphereGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const sphereMaterial = new THREE.MeshStandardMaterial({
                color: 0xffffff,
                metalness: 1.0,
                roughness: 0.0,
                emissive: 0xffffff,
                emissiveIntensity: 0.2
            });
            
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            group.add(sphere);
            
            group.userData = { segments, sphere };
            group.visible = false;
            scene.add(group);
            return group;
        }

        // 创建3D地形可视化
        function createTerrain() {
            const group = new THREE.Group();
            group.position.set(0, 0.5, 0);
            
            const size = 32;
            const geometry = new THREE.PlaneGeometry(5, 5, size - 1, size - 1);
            geometry.rotateX(-Math.PI / 2);
            
            // 创建顶点颜色数组
            const colors = [];
            const positions = geometry.attributes.position.array;
            
            for (let i = 0; i < positions.length / 3; i++) {
                colors.push(0, 0.5, 1); // 蓝色
            }
            
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            const material = new THREE.MeshStandardMaterial({
                vertexColors: true,
                wireframe: false,
                metalness: 0.5,
                roughness: 0.5,
                side: THREE.DoubleSide
            });
            
            const terrain = new THREE.Mesh(geometry, material);
            group.add(terrain);
            
            // 添加线框
            const wireframeMaterial = new THREE.MeshBasicMaterial({
                color: 0xffffff,
                wireframe: true,
                transparent: true,
                opacity: 0.2
            });
            
            const wireframe = new THREE.Mesh(geometry.clone(), wireframeMaterial);
            group.add(wireframe);
            
            group.userData = { terrain, wireframe, size };
            group.visible = false;
            scene.add(group);
            return group;
        }

        // 更新可视化
        function updateVisualization() {
            if (!analyser || !isPlaying) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            // 隐藏所有可视化
            visualizationObjects.bars.visible = false;
            visualizationObjects.circle.visible = false;
            visualizationObjects.terrain.visible = false;
            
            // 显示当前可视化模式
            switch (visualizationMode) {
                case 0: // 条形图
                    updateBars(dataArray);
                    break;
                case 1: // 圆形
                    updateCircle(dataArray);
                    break;
                case 2: // 3D地形
                    updateTerrain(dataArray);
                    break;
            }
        }

        // 更新条形可视化
        function updateBars(dataArray) {
            visualizationObjects.bars.visible = true;
            const bars = visualizationObjects.bars.userData.bars;
            const step = Math.floor(dataArray.length / bars.length);
            
            for (let i = 0; i < bars.length; i++) {
                const value = dataArray[i * step] / 255;
                const height = value * 3 + 0.1; // 最小高度为0.1
                
                bars[i].scale.y = height;
                bars[i].position.y = height / 2;
                
                // 根据频率更新颜色
                const hue = (i / bars.length) * 360;
                const color = new THREE.Color(`hsl(${hue}, ${value * 100}%, ${50 + value * 50}%)`);
                bars[i].material.color.copy(color);
                bars[i].material.emissive.copy(color);
                bars[i].material.emissiveIntensity = value * 0.5;
            }
        }

        // 更新圆形可视化
        function updateCircle(dataArray) {
            visualizationObjects.circle.visible = true;
            const segments = visualizationObjects.circle.userData.segments;
            const sphere = visualizationObjects.circle.userData.sphere;
            const step = Math.floor(dataArray.length / segments.length);
            
            let averageValue = 0;
            
            for (let i = 0; i < segments.length; i++) {
                const value = dataArray[i * step] / 255;
                averageValue += value;
                
                const height = value * 2 + 0.1; // 最小高度为0.1
                segments[i].scale.y = height;
                segments[i].position.y = height / 2;
                
                // 增强发光效果
                segments[i].material.emissiveIntensity = value * 0.5;
            }
            
            // 更新中心球体
            averageValue /= segments.length;
            sphere.scale.set(
                0.5 + averageValue * 0.5,
                0.5 + averageValue * 0.5,
                0.5 + averageValue * 0.5
            );
            
            // 脉动颜色
            const hue = (Date.now() * 0.05) % 360;
            const sphereColor = new THREE.Color(`hsl(${hue}, 100%, 50%)`);
            sphere.material.color.copy(sphereColor);
            sphere.material.emissive.copy(sphereColor);
            sphere.material.emissiveIntensity = 0.2 + averageValue * 0.8;
            
            // 旋转圆环
            visualizationObjects.circle.rotation.y += 0.005;
        }

        // 更新3D地形可视化
        function updateTerrain(dataArray) {
            visualizationObjects.terrain.visible = true;
            const terrain = visualizationObjects.terrain.userData.terrain;
            const wireframe = visualizationObjects.terrain.userData.wireframe;
            const size = visualizationObjects.terrain.userData.size;
            
            const positions = terrain.geometry.attributes.position.array;
            const colors = terrain.geometry.attributes.color.array;
            const step = Math.floor(dataArray.length / (size * size));
            
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const index = i * size + j;
                    const posIndex = index * 3;
                    const colorIndex = index * 3;
                    
                    // 使用音频数据更新高度
                    const dataIndex = index * step;
                    const value = dataIndex < dataArray.length ? dataArray[dataIndex] / 255 : 0;
                    positions[posIndex + 1] = value * 2;
                    
                    // 更新颜色
                    const hue = (value * 270) % 360; // 从蓝色到紫色
                    const color = new THREE.Color(`hsl(${hue}, 100%, ${50 + value * 50}%)`);
                    colors[colorIndex] = color.r;
                    colors[colorIndex + 1] = color.g;
                    colors[colorIndex + 2] = color.b;
                }
            }
            
            terrain.geometry.attributes.position.needsUpdate = true;
            terrain.geometry.attributes.color.needsUpdate = true;
            
            // 同步线框几何体
            wireframe.geometry.attributes.position.array.set(positions);
            wireframe.geometry.attributes.position.needsUpdate = true;
            
            // 旋转地形
            visualizationObjects.terrain.rotation.y += 0.005;
        }

        // 按钮事件
        document.getElementById('play-demo').addEventListener('click', function() {
            loadAudio('https://cdn.freesound.org/previews/328/328647_230356-lq.mp3');
        });

        document.getElementById('upload-audio').addEventListener('click', function() {
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            setupAudioContext();
            
            // 如果有之前的音频元素，先移除
            if (audioElement) {
                audioElement.pause();
                audioElement.src = '';
                audioElement = null;
            }
            
            // 创建新的音频元素
            audioElement = new Audio();
            audioElement.src = URL.createObjectURL(file);
            audioBuffer = null; // 清除之前的缓冲区
            
            document.getElementById('toggle-play').disabled = false;
            document.getElementById('audio-info').textContent = `已加载文件: ${file.name}`;
        });

        document.getElementById('toggle-play').addEventListener('click', function() {
            if (!isPlaying) {
                playAudio();
            } else {
                pauseAudio();
            }
        });

        document.getElementById('toggle-visualization').addEventListener('click', function() {
            visualizationMode = (visualizationMode + 1) % visualizationModes.length;
            document.getElementById('audio-info').textContent = `可视化模式: ${visualizationModes[visualizationMode]}`;
        });

        // VR控制器设置
        const controllerModelFactory = new XRControllerModelFactory();
        
        // 控制器1
        const controller1 = renderer.xr.getController(0);
        controller1.addEventListener('selectstart', onSelectStart);
        scene.add(controller1);

        const controllerGrip1 = renderer.xr.getControllerGrip(0);
        controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
        scene.add(controllerGrip1);

        // 控制器2
        const controller2 = renderer.xr.getController(1);
        controller2.addEventListener('selectstart', onSelectStart);
        scene.add(controller2);

        const controllerGrip2 = renderer.xr.getControllerGrip(1);
        controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
        scene.add(controllerGrip2);

        // 控制器射线辅助
        const geometry = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -1)]);
        const line = new THREE.Line(geometry);
        line.scale.z = 5;

        controller1.add(line.clone());
        controller2.add(line.clone());

        // VR控制器交互
        function onSelectStart(event) {
            const controller = event.target;
            
            // 切换可视化模式
            visualizationMode = (visualizationMode + 1) % visualizationModes.length;
            document.getElementById('audio-info').textContent = `可视化模式: ${visualizationModes[visualizationMode]}`;
            
            // 振动反馈
            if (controller.gamepad) {
                controller.gamepad.hapticActuators[0].pulse(0.5, 100);
            }
        }

        // 时钟
        const clock = new THREE.Clock();

        // 动画
        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            const delta = clock.getDelta();
            
            // 更新可视化
            updateVisualization();
            
            renderer.render(scene, camera);
        }

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // 默认显示条形可视化
        visualizationObjects.bars.visible = true;
        document.getElementById('audio-info').textContent = `可视化模式: ${visualizationModes[visualizationMode]}`;

        animate();
    </script>
</body>
</html>