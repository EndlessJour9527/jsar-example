<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>粒子效果 - ThreeJS XR 测试案例</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            font-family: Arial, sans-serif;
            pointer-events: none;
            text-shadow: 0 0 5px black;
        }
        #back-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            z-index: 100;
        }
        #back-button:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        #vr-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-weight: bold;
            z-index: 100;
        }
        #vr-button:hover {
            background-color: #0b7dda;
        }
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            z-index: 100;
        }
        button {
            margin: 5px;
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="info">粒子效果 - 使用粒子系统创建各种视觉效果</div>
    <button id="back-button" onclick="window.location.href='../index.html'">返回</button>
    <button id="vr-button">进入 VR</button>
    <div id="controls">
        <button id="fire-button">创建火焰</button>
        <button id="smoke-button">创建烟雾</button>
        <button id="explosion-button">创建爆炸</button>
        <button id="clear-button">清除所有</button>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';

        // 场景初始化
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        scene.fog = new THREE.FogExp2(0x000000, 0.001);

        // 相机设置
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 1.6, 5);

        // 渲染器设置
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // VR按钮
        document.getElementById('vr-button').addEventListener('click', function() {
            document.body.appendChild(VRButton.createButton(renderer));
            document.getElementById('vr-button').style.display = 'none';
        });

        // 控制器
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 1, 0);
        controls.update();

        // 光照设置
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const pointLight = new THREE.PointLight(0xffffff, 1);
        pointLight.position.set(0, 2, 0);
        scene.add(pointLight);

        // 地面
        const floorGeometry = new THREE.PlaneGeometry(20, 20);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.8 });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.receiveShadow = true;
        scene.add(floor);

        // 网格辅助
        const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x444444);
        scene.add(gridHelper);

        // 粒子系统管理
        const particleSystems = [];

        // 创建火焰粒子系统
        function createFireParticles(position = new THREE.Vector3(0, 0, 0)) {
            const particleCount = 1000;
            const particleGeometry = new THREE.BufferGeometry();
            const particleTexture = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png');

            // 粒子属性
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);
            const lifetimes = new Float32Array(particleCount);
            const velocities = [];

            // 初始化粒子
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                // 位置 - 在圆柱体内随机分布
                const radius = 0.1 * Math.random();
                const theta = Math.random() * Math.PI * 2;
                positions[i3] = position.x + radius * Math.cos(theta);
                positions[i3 + 1] = position.y;
                positions[i3 + 2] = position.z + radius * Math.sin(theta);
                
                // 颜色 - 从红色到黄色
                colors[i3] = 1.0; // R
                colors[i3 + 1] = 0.3 + 0.7 * Math.random(); // G
                colors[i3 + 2] = 0.1 * Math.random(); // B
                
                // 大小
                sizes[i] = 4 + 8 * Math.random();
                
                // 生命周期
                lifetimes[i] = 1 + Math.random();
                
                // 速度
                velocities.push(new THREE.Vector3(
                    (Math.random() - 0.5) * 0.1,
                    0.5 + Math.random() * 0.5,
                    (Math.random() - 0.5) * 0.1
                ));
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // 粒子材质
            const particleMaterial = new THREE.PointsMaterial({
                size: 1,
                map: particleTexture,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                vertexColors: true
            });

            // 创建粒子系统
            const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            particleSystem.userData = {
                velocities: velocities,
                lifetimes: lifetimes,
                type: 'fire',
                initialPosition: position.clone(),
                time: 0
            };
            
            scene.add(particleSystem);
            particleSystems.push(particleSystem);
            
            return particleSystem;
        }

        // 创建烟雾粒子系统
        function createSmokeParticles(position = new THREE.Vector3(0, 0, 0)) {
            const particleCount = 500;
            const particleGeometry = new THREE.BufferGeometry();
            const particleTexture = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/smoke.png');

            // 粒子属性
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);
            const lifetimes = new Float32Array(particleCount);
            const velocities = [];

            // 初始化粒子
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                // 位置 - 在圆柱体内随机分布
                const radius = 0.2 * Math.random();
                const theta = Math.random() * Math.PI * 2;
                positions[i3] = position.x + radius * Math.cos(theta);
                positions[i3 + 1] = position.y;
                positions[i3 + 2] = position.z + radius * Math.sin(theta);
                
                // 颜色 - 灰色
                const gray = 0.3 + 0.5 * Math.random();
                colors[i3] = gray; // R
                colors[i3 + 1] = gray; // G
                colors[i3 + 2] = gray; // B
                
                // 大小
                sizes[i] = 10 + 20 * Math.random();
                
                // 生命周期
                lifetimes[i] = 2 + 3 * Math.random();
                
                // 速度
                velocities.push(new THREE.Vector3(
                    (Math.random() - 0.5) * 0.05,
                    0.1 + Math.random() * 0.1,
                    (Math.random() - 0.5) * 0.05
                ));
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // 粒子材质
            const particleMaterial = new THREE.PointsMaterial({
                size: 1,
                map: particleTexture,
                blending: THREE.NormalBlending,
                depthWrite: false,
                transparent: true,
                vertexColors: true
            });

            // 创建粒子系统
            const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            particleSystem.userData = {
                velocities: velocities,
                lifetimes: lifetimes,
                type: 'smoke',
                initialPosition: position.clone(),
                time: 0
            };
            
            scene.add(particleSystem);
            particleSystems.push(particleSystem);
            
            return particleSystem;
        }

        // 创建爆炸粒子系统
        function createExplosionParticles(position = new THREE.Vector3(0, 0, 0)) {
            const particleCount = 1500;
            const particleGeometry = new THREE.BufferGeometry();
            const particleTexture = new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png');

            // 粒子属性
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);
            const lifetimes = new Float32Array(particleCount);
            const velocities = [];

            // 初始化粒子
            for (let i = 0; i < particleCount; i++) {
                const i3 = i * 3;
                
                // 位置 - 在球体内随机分布
                positions[i3] = position.x;
                positions[i3 + 1] = position.y;
                positions[i3 + 2] = position.z;
                
                // 颜色 - 从黄色到红色
                colors[i3] = 1.0; // R
                colors[i3 + 1] = 0.5 * Math.random(); // G
                colors[i3 + 2] = 0.1 * Math.random(); // B
                
                // 大小
                sizes[i] = 2 + 6 * Math.random();
                
                // 生命周期
                lifetimes[i] = 0.5 + Math.random() * 0.5;
                
                // 速度 - 从中心向外爆发
                const direction = new THREE.Vector3(
                    Math.random() * 2 - 1,
                    Math.random() * 2 - 1,
                    Math.random() * 2 - 1
                ).normalize();
                
                const speed = 1 + Math.random() * 2;
                velocities.push(direction.multiplyScalar(speed));
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // 粒子材质
            const particleMaterial = new THREE.PointsMaterial({
                size: 1,
                map: particleTexture,
                blending: THREE.AdditiveBlending,
                depthWrite: false,
                transparent: true,
                vertexColors: true
            });

            // 创建粒子系统
            const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            particleSystem.userData = {
                velocities: velocities,
                lifetimes: lifetimes,
                type: 'explosion',
                initialPosition: position.clone(),
                time: 0
            };
            
            scene.add(particleSystem);
            particleSystems.push(particleSystem);
            
            // 添加光照效果
            const light = new THREE.PointLight(0xff7700, 2, 10);
            light.position.copy(position);
            scene.add(light);
            
            // 光照淡出动画
            const lightFade = setInterval(() => {
                light.intensity -= 0.1;
                if (light.intensity <= 0) {
                    scene.remove(light);
                    clearInterval(lightFade);
                }
            }, 50);
            
            return particleSystem;
        }

        // 更新粒子系统
        function updateParticles(delta) {
            for (let i = particleSystems.length - 1; i >= 0; i--) {
                const system = particleSystems[i];
                const positions = system.geometry.attributes.position.array;
                const colors = system.geometry.attributes.color.array;
                const sizes = system.geometry.attributes.size.array;
                const velocities = system.userData.velocities;
                const lifetimes = system.userData.lifetimes;
                const type = system.userData.type;
                
                system.userData.time += delta;
                
                let systemAlive = false;
                
                for (let j = 0; j < positions.length / 3; j++) {
                    const j3 = j * 3;
                    
                    // 更新生命周期
                    lifetimes[j] -= delta;
                    
                    if (lifetimes[j] > 0) {
                        systemAlive = true;
                        
                        // 更新位置
                        positions[j3] += velocities[j].x * delta;
                        positions[j3 + 1] += velocities[j].y * delta;
                        positions[j3 + 2] += velocities[j].z * delta;
                        
                        // 根据粒子类型更新属性
                        if (type === 'fire') {
                            // 火焰颜色从黄色渐变到红色
                            colors[j3 + 1] = Math.max(0, colors[j3 + 1] - 0.1 * delta);
                            sizes[j] = Math.max(1, sizes[j] - 2 * delta);
                            
                            // 添加一些随机抖动
                            velocities[j].x += (Math.random() - 0.5) * 0.01;
                            velocities[j].z += (Math.random() - 0.5) * 0.01;
                            
                            // 重力和上升力
                            velocities[j].y -= 0.01 * delta; // 轻微重力
                        } 
                        else if (type === 'smoke') {
                            // 烟雾变得更透明
                            colors[j3] = Math.max(0, colors[j3] - 0.05 * delta);
                            colors[j3 + 1] = Math.max(0, colors[j3 + 1] - 0.05 * delta);
                            colors[j3 + 2] = Math.max(0, colors[j3 + 2] - 0.05 * delta);
                            
                            // 烟雾扩散
                            sizes[j] = Math.min(30, sizes[j] + 5 * delta);
                            
                            // 添加一些随机抖动
                            velocities[j].x += (Math.random() - 0.5) * 0.02;
                            velocities[j].z += (Math.random() - 0.5) * 0.02;
                        } 
                        else if (type === 'explosion') {
                            // 爆炸粒子变暗
                            colors[j3] = Math.max(0, colors[j3] - 0.2 * delta);
                            colors[j3 + 1] = Math.max(0, colors[j3 + 1] - 0.2 * delta);
                            
                            // 爆炸粒子变小
                            sizes[j] = Math.max(0.5, sizes[j] - 3 * delta);
                            
                            // 重力影响
                            velocities[j].y -= 0.5 * delta;
                        }
                    } else {
                        // 粒子生命周期结束，重置或隐藏
                        if (type === 'fire' || type === 'smoke') {
                            // 重置到初始位置
                            const radius = 0.1 * Math.random();
                            const theta = Math.random() * Math.PI * 2;
                            positions[j3] = system.userData.initialPosition.x + radius * Math.cos(theta);
                            positions[j3 + 1] = system.userData.initialPosition.y;
                            positions[j3 + 2] = system.userData.initialPosition.z + radius * Math.sin(theta);
                            
                            if (type === 'fire') {
                                colors[j3] = 1.0;
                                colors[j3 + 1] = 0.3 + 0.7 * Math.random();
                                colors[j3 + 2] = 0.1 * Math.random();
                                sizes[j] = 4 + 8 * Math.random();
                                lifetimes[j] = 1 + Math.random();
                                velocities[j].set(
                                    (Math.random() - 0.5) * 0.1,
                                    0.5 + Math.random() * 0.5,
                                    (Math.random() - 0.5) * 0.1
                                );
                            } else {
                                const gray = 0.3 + 0.5 * Math.random();
                                colors[j3] = gray;
                                colors[j3 + 1] = gray;
                                colors[j3 + 2] = gray;
                                sizes[j] = 10 + 20 * Math.random();
                                lifetimes[j] = 2 + 3 * Math.random();
                                velocities[j].set(
                                    (Math.random() - 0.5) * 0.05,
                                    0.1 + Math.random() * 0.1,
                                    (Math.random() - 0.5) * 0.05
                                );
                            }
                            
                            systemAlive = true;
                        } else {
                            // 爆炸粒子不重置，让它们消失
                            positions[j3] = 0;
                            positions[j3 + 1] = -1000; // 移出视野
                            positions[j3 + 2] = 0;
                            colors[j3] = 0;
                            colors[j3 + 1] = 0;
                            colors[j3 + 2] = 0;
                            sizes[j] = 0;
                        }
                    }
                }
                
                // 更新几何体属性
                system.geometry.attributes.position.needsUpdate = true;
                system.geometry.attributes.color.needsUpdate = true;
                system.geometry.attributes.size.needsUpdate = true;
                
                // 如果系统不再活跃，移除它
                if (!systemAlive && type === 'explosion') {
                    scene.remove(system);
                    particleSystems.splice(i, 1);
                }
            }
        }

        // 按钮事件
        document.getElementById('fire-button').addEventListener('click', function() {
            const position = new THREE.Vector3(
                (Math.random() - 0.5) * 4,
                0.1,
                (Math.random() - 0.5) * 4
            );
            createFireParticles(position);
        });

        document.getElementById('smoke-button').addEventListener('click', function() {
            const position = new THREE.Vector3(
                (Math.random() - 0.5) * 4,
                0.1,
                (Math.random() - 0.5) * 4
            );
            createSmokeParticles(position);
        });

        document.getElementById('explosion-button').addEventListener('click', function() {
            const position = new THREE.Vector3(
                (Math.random() - 0.5) * 4,
                1 + Math.random() * 2,
                (Math.random() - 0.5) * 4
            );
            createExplosionParticles(position);
        });

        document.getElementById('clear-button').addEventListener('click', function() {
            // 移除所有粒子系统
            for (let i = particleSystems.length - 1; i >= 0; i--) {
                scene.remove(particleSystems[i]);
            }
            particleSystems.length = 0;
        });

        // VR控制器设置
        const controllerModelFactory = new XRControllerModelFactory();
        
        // 控制器1
        const controller1 = renderer.xr.getController(0);
        controller1.addEventListener('selectstart', onSelectStart);
        scene.add(controller1);

        const controllerGrip1 = renderer.xr.getControllerGrip(0);
        controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
        scene.add(controllerGrip1);

        // 控制器2
        const controller2 = renderer.xr.getController(1);
        controller2.addEventListener('selectstart', onSelectStart);
        scene.add(controller2);

        const controllerGrip2 = renderer.xr.getControllerGrip(1);
        controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
        scene.add(controllerGrip2);

        // 控制器射线辅助
        const geometry = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), new THREE.Vector3(0, 0, -1)]);
        const line = new THREE.Line(geometry);
        line.scale.z = 5;

        controller1.add(line.clone());
        controller2.add(line.clone());

        // VR控制器交互
        function onSelectStart(event) {
            const controller = event.target;
            const position = new THREE.Vector3();
            position.setFromMatrixPosition(controller.matrixWorld);
            
            // 随机选择粒子效果
            const effectType = Math.floor(Math.random() * 3);
            switch(effectType) {
                case 0:
                    createFireParticles(position);
                    break;
                case 1:
                    createSmokeParticles(position);
                    break;
                case 2:
                    createExplosionParticles(position);
                    break;
            }
            
            // 振动反馈
            if (controller.gamepad) {
                controller.gamepad.hapticActuators[0].pulse(0.5, 100);
            }
        }

        // 时钟
        const clock = new THREE.Clock();

        // 动画
        function animate() {
            renderer.setAnimationLoop(render);
        }

        function render() {
            const delta = clock.getDelta();
            
            // 更新粒子系统
            updateParticles(delta);

            renderer.render(scene, camera);
        }

        // 窗口大小调整
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', onWindowResize);

        // 初始化一些粒子效果
        createFireParticles(new THREE.Vector3(-2, 0.1, 0));
        createSmokeParticles(new THREE.Vector3(0, 0.1, 0));
        createExplosionParticles(new THREE.Vector3(2, 1, 0));

        animate();
    </script>
</body>
</html>